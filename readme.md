# WB Tariffs Integration Service

–°–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤ Wildberries —á–µ—Ä–µ–∑ API –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Ö –≤ PostgreSQL —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –≤ Google Sheets.

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–¥–∞—á—É:

1. **–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞—Ä–∏—Ñ–∞—Ö WB** - –µ–∂–µ—á–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: 2. **–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Google Sheets** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –≤ Google —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ï–∂–µ—á–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∫–æ—Ä–æ–±–æ–≤ –∏–∑ WB API
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–Ω—è–º –≤ PostgreSQL
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
- ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Graceful shutdown
- ‚úÖ –ó–∞–ø—É—Å–∫ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- üîß **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º Google Sheets

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Node.js** + **TypeScript**
- **PostgreSQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **Knex.js** - —Ä–∞–±–æ—Ç–∞ —Å –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- **Google Sheets API** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- **node-cron** - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **log4js** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Docker** + **Docker Compose** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:**

- Docker –∏ Docker Compose
- WB API —Ç–æ–∫–µ–Ω

**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**

- Node.js 20+

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–¥–ª—è Google Sheets):**

- Google Service Account —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ Google Sheets API

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd btlz-wb-test
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ example.env –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ** –∑–Ω–∞—á–µ–Ω–∏—è:

```bash
cp example.env .env
```

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ WB API ‚Üí PostgreSQL):**

```env
# PostgreSQL (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
POSTGRES_PORT=5432
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_secure_password

APP_PORT=5000

# WB API (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
WB_API_TOKEN=your_wb_api_token_here
WB_API_BASE_URL=https://common-api.wildberries.ru
WB_API_TIMEOUT=30000

# Google Sheets (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û - –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
# GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@your-project.iam.gserviceaccount.com
# GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END PRIVATE KEY-----\n"
# GOOGLE_SPREADSHEET_IDS=spreadsheet_id_1,spreadsheet_id_2

# Scheduler (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
TARIFF_FETCH_CRON=0 * * * *        # –ö–∞–∂–¥—ã–π —á–∞—Å
SHEETS_SYNC_CRON=0 */6 * * *       # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

# Logging (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
LOG_LEVEL=info
```

> **üí° –°–æ–≤–µ—Ç:** –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –æ—Å—Ç–∞–≤—å—Ç–µ Google Sheets –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å –ë–î.

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ WB API —Ç–æ–∫–µ–Ω–∞

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞ Wildberries
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª API
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `WB_API_TOKEN`

### 4. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
docker compose up --build
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

- –ó–∞–ø—É—Å—Ç–∏—Ç PostgreSQL
- –í—ã–ø–æ–ª–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- –í—ã–ø–æ–ª–Ω–∏—Ç –Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ç–∞—Ä–∏—Ñ–æ–≤
- –ó–∞–ø—É—Å—Ç–∏—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
docker compose logs -f app
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
[INFO] Starting WB Tariffs Integration Service
[INFO] Successfully fetched box tariffs from WB API
[INFO] Transformed 44 tariffs for storage
[INFO] Successfully upserted 44 tariffs
[INFO] Google Sheets sync not scheduled: not configured  ‚Üê —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ!
[INFO] WB Tariffs Integration Service started successfully
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î:

```bash
docker compose exec postgres psql -U postgres -d postgres -c "SELECT COUNT(*) FROM tariffs;"
```

---

## üîß –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å Google Sheets, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Service Account

#### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ Service Account

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Google Cloud Console](https://console.cloud.google.com/)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –í–∫–ª—é—á–∏—Ç–µ Google Sheets API:
    - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "APIs & Services" > "Library"
    - –ù–∞–π–¥–∏—Ç–µ "Google Sheets API"
    - –ù–∞–∂–º–∏—Ç–µ "Enable"
4. –°–æ–∑–¥–∞–π—Ç–µ Service Account:
    - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "IAM & Admin" > "Service Accounts"
    - –ù–∞–∂–º–∏—Ç–µ "Create Service Account"
    - –£–∫–∞–∂–∏—Ç–µ –∏–º—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    - –ù–∞–∂–º–∏—Ç–µ "Create and Continue"
    - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —à–∞–≥–∏ —Å —Ä–æ–ª—è–º–∏
    - –ù–∞–∂–º–∏—Ç–µ "Done"

#### 1.2 –ü–æ–ª—É—á–µ–Ω–∏–µ credentials

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Service Account
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "Keys"
3. –ù–∞–∂–º–∏—Ç–µ "Add Key" > "Create new key"
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON
5. –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª —Å –∫–ª—é—á–æ–º

#### 1.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ò–∑ —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ JSON —Ñ–∞–π–ª–∞ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ:

- `client_email` ‚Üí `GOOGLE_SERVICE_ACCOUNT_EMAIL`
- `private_key` ‚Üí `GOOGLE_PRIVATE_KEY` (–≤–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ `\n`)

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤ `.env`:

```env
GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@your-project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END PRIVATE KEY-----\n"
GOOGLE_SPREADSHEET_IDS=spreadsheet_id_1,spreadsheet_id_2
```

#### 1.4 –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–∂–¥—É—é Google —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
2. –ù–∞–∂–º–∏—Ç–µ "Share" (–ü–æ–¥–µ–ª–∏—Ç—å—Å—è)
3. –î–æ–±–∞–≤—å—Ç–µ email –≤–∞—à–µ–≥–æ Service Account (–∏–∑ `GOOGLE_SERVICE_ACCOUNT_EMAIL`)
4. –î–∞–π—Ç–µ –ø—Ä–∞–≤–∞ "Editor" (–†–µ–¥–∞–∫—Ç–æ—Ä)
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –∏–∑ URL (—á–∞—Å—Ç—å –º–µ–∂–¥—É `/d/` –∏ `/edit`)
6. –î–æ–±–∞–≤—å—Ç–µ ID –≤ `GOOGLE_SPREADSHEET_IDS` (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü)

#### 1.5 –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–ª—è —Ç–∞—Ä–∏—Ñ–æ–≤

–í –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ —Å–æ–∑–¥–∞–π—Ç–µ –ª–∏—Å—Ç —Å –∏–º–µ–Ω–µ–º `stocks_coefs` - –∏–º–µ–Ω–Ω–æ –≤ –Ω–µ–≥–æ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ.

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞

```bash
docker compose restart app
```

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
[INFO] Scheduling Google Sheets sync
[INFO] Google Sheets sync scheduled successfully
```

---

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
docker compose logs -f app
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

- –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ù–∞—á–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ç–∞—Ä–∏—Ñ–æ–≤ –∏–∑ WB API
- –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app.ts                          # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ env/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ env.ts                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ knex/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ knexfile.ts             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Knex.js
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wb-api/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wb-client.ts            # WB API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wb-types.ts             # –¢–∏–ø—ã –∏ —Å—Ö–µ–º—ã
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wb-config.ts            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WB API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tariff/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tariff-service.ts       # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tariff-repository.ts    # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ google-sheets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sheets-client.ts        # Google Sheets API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sheets-sync.ts          # –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sheets-config.ts        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Google Sheets
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scheduler/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ scheduler.ts            # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
‚îÇ   ‚îú‚îÄ‚îÄ postgres/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knex.ts                     # Knex instance
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ seeds/                      # Seeds
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ logger.ts                   # –£—Ç–∏–ª–∏—Ç–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ retry.ts                    # –£—Ç–∏–ª–∏—Ç–∞ retry
‚îÇ       ‚îî‚îÄ‚îÄ knex.ts                     # CLI –¥–ª—è Knex
‚îú‚îÄ‚îÄ compose.yaml                        # Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile                          # Dockerfile –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ example.env                         # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md
```

## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `tariffs`

| –ö–æ–ª–æ–Ω–∫–∞        | –¢–∏–ø           | –û–ø–∏—Å–∞–Ω–∏–µ               |
| -------------- | ------------- | ---------------------- |
| id             | SERIAL        | Primary key            |
| date           | DATE          | –î–∞—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞            |
| warehouse_name | VARCHAR(255)  | –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞        |
| box_type       | VARCHAR(100)  | –¢–∏–ø –∫–æ—Ä–æ–±–∞             |
| delivery_type  | VARCHAR(100)  | –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏           |
| coefficient    | DECIMAL(10,2) | –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç            |
| raw_data       | JSONB         | –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API   |
| created_at     | TIMESTAMP     | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏   |
| updated_at     | TIMESTAMP     | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ |

**Constraints:**

- Unique constraint –Ω–∞ `(date, warehouse_name, box_type, delivery_type)`

**Indexes:**

- `idx_tariffs_date` –Ω–∞ `date`
- `idx_tariffs_warehouse` –Ω–∞ `warehouse_name`
- `idx_tariffs_coefficient` –Ω–∞ `coefficient`

## –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets

–õ–∏—Å—Ç `stocks_coefs` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏:

| Warehouse | Box Type | Delivery Type | Coefficient | Date       |
| --------- | -------- | ------------- | ----------- | ---------- |
| –ö–æ–ª–µ–¥–∏–Ω–æ  | –ö–æ—Ä–æ–±    | Standard      | 1.25        | 2025-10-22 |

–î–∞–Ω–Ω—ã–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—É (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é).

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –ó–∞–ø—É—Å–∫ –ë–î
docker compose up -d postgres

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
npm run knex:dev migrate latest

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
npm run dev
```

### –†–∞–±–æ—Ç–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
npm run knex:dev migrate make migration_name

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npm run knex:dev migrate latest

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
npm run knex:dev migrate rollback

# –°–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π
npm run knex:dev migrate list
```

### –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ production

```bash
# –°–±–æ—Ä–∫–∞ TypeScript
npm run build

# –ó–∞–ø—É—Å–∫ production –≤–µ—Ä—Å–∏–∏
npm run start
```

### Docker –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker compose logs -f app

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker compose down --volumes --rmi local

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker compose up --build
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ cron –≤—ã—Ä–∞–∂–µ–Ω–∏—è:

### TARIFF_FETCH_CRON (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0 * * * *`)

–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤ –∏–∑ WB API

–ü—Ä–∏–º–µ—Ä—ã:

- `0 * * * *` - –∫–∞–∂–¥—ã–π —á–∞—Å –≤ –Ω–∞—á–∞–ª–µ —á–∞—Å–∞
- `*/30 * * * *` - –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- `0 */2 * * *` - –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞

### SHEETS_SYNC_CRON (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0 */6 * * *`)

–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets

–ü—Ä–∏–º–µ—Ä—ã:

- `0 */6 * * *` - –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- `0 0 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
- `0 */3 * * *` - –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `LOG_LEVEL`):

- `error` - —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
- `warn` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏
- `info` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `debug` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ stdout –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å Docker.

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### WB API

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å exponential backoff (3 –ø–æ–ø—ã—Ç–∫–∏)
- –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 5 –º–∏–Ω—É—Ç
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 30 –º–∏–Ω—É—Ç
- –û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (401/403) –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è

### Google Sheets

- –ö–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ
- Rate limiting –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è batch –æ–ø–µ—Ä–∞—Ü–∏–π
- Constraint violations –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ warnings
- Connection errors –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ WB API

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –≤ `WB_API_TOKEN`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Ç–æ–∫–µ–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets

**–†–µ—à–µ–Ω–∏–µ:**

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Service Account –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `GOOGLE_PRIVATE_KEY` (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `\n`)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Google Sheets API –≤–∫–ª—é—á–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
docker compose logs postgres

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é
docker compose exec app npm run knex migrate latest
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Google Sheets

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏—Å—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `stocks_coefs`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: `docker compose logs -f app | grep sheets-sync`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ: –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ PostgreSQL –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `tariffs`

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ `.env` —Ñ–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`
- ‚úÖ `example.env` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ placeholders
- ‚úÖ Private keys –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–¥–µ
- ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏

## –õ–∏—Ü–µ–Ω–∑–∏—è

ISC

## –ê–≤—Ç–æ—Ä

lucard17
